{html:meta:keywords}multiple, file, upload{:html}
{html:meta:description}Upload based on Dropzone.js{:html}
{html:inner:title}thumbnail, previews, retina enabled, multiple files, synchronous uploads, browser image resizing,
  progress update, support for large files, complete theming{:html}

{html:append:head}
<script src="../../js/rkPhpLib.js"></script>
<script src="../../js/dropzone.js"></script>
<link rel="stylesheet" href="../../css/dropzone.css" />
{:html}

{tpl_set:ajax_output_upload}
{get:*}
{:tpl_set}

{upload:init:file}
save_in= data/upload|#|
thumbnail= 120x120^|#|
ajax_output= ajax_output_upload|#|
{:upload}

<form action="index.php" method="post" enctype="multipart/form-data" onSubmit="return checkDropzone(this);">
	<div class="dropzone" id="rkDropzone"></div>

	<input type="hidden" id="fvin_module" name="module" value="{get:module}">
	<input type="hidden" id="fvin_id" name="id" value="{rand:8}">
	<input type="hidden" id="fvin_dir" name="dir" value="{get:dir}">

	<input type="text" name="something" value="{if:}{get:something}|#|{get:something}|#|{rand:8}{:if}">
	<input type="submit" id="fvin_submit">
</form>

<script>
// Dropzone.autoDiscover = false;
var dropzone_done = false;

function checkDropzone(f) {
	console.log('checkDropzone', f);

	if (dropzone_done) {
		f.submit();
	}
	else {
		document.getElementById('fvin_submit').setAttribute('readonly', 'readonly');
		setTimeout(function(f) { checkDropzone(f); }, 500);
	}

	return false;
}

Dropzone.options.rkDropzone = {
	url: 'index.php?dir={get:dir}',
	autoProcessQueue: true,
	uploadMultiple: true,
//	paramName: "images",
	parallelUploads: 5,
	maxFiles: 7,
	maxFilesize: 20, // mb
	acceptedFiles: 'image/*',
	addRemoveLinks: true,
	dictMaxFilesExceeded: "{ptxt:}Sie können nicht mehr als $p1x Dateien hochladen.|#|{{maxFiles}}{:ptxt}",
	dictRemoveFileConfirmation: "{txt:}Möchsten Sie diese Datei entfernen?{:txt}",
	dictMaxFilesExceeded: "{txt:}Sie können keine weiteren Dateien hochladen.{:txt}",
	dictRemoveFile: "{txt:}Löschen{:txt}",
	dictCancelUploadConfirmation: "{txt:}Möchten Sie diesen Upload wirklich abbrechen?{:txt}",
	dictUploadCanceled: "{txt:}Upload wurde abgebrochen.{:txt}",
	dictCancelUpload: "{txt:}Upload abbrechen{:txt}",
	dictResponseError: "{ptxt:}Server meldet Fehler $p1x|#|{{statusCode}}{:ptxt}",
	dictInvalidFileType: "{txt:}Dieser Dateityp ist nicht zulässig.{:txt}",
	dictFileTooBig: "{ptxt:}Datei ist zu gross ($p1x MiB). Maximale Dateigröße: $p2x MiB.|#|{{filesize}}|#|{{maxFilesize}}{:ptxt}",
	dictFallbackText: "{txt:}Bitte benutzen Sie den Upload Button.{:txt}",
	dictFallbackMessage: "{txt:}Ihr Browser unterstützt das Hochladen per Drag &amp; Drop nicht.{:txt}",
	dictDefaultMessage: "{txt:}Hier klicken oder Dateien hereinziehen, um hochzuladen{:txt}",

	rk: { currFiles: 0, newFiles: 0 },

	init: function() {
		dzClosure = this; // Makes sure that 'this' is understood inside the functions below.

		this.on("sendingmultiple", function(data, xhr, formData) {
			console.log('sendingmultiple');
			formData.append("id", document.getElementById('fvin_id').value);
			formData.append("dir", document.getElementById('fvin_dir').value);
			formData.append("module", document.getElementById('fvin_module').value);
		});

		this.on("queuecomplete", function() {
			console.log('queuecomplete');
			// dropzone_done = true;
			// for testing only
			setTimeout(function() { dropzone_done = true; }, 3000);
		});

		this.on("removedfile", function(file) {
			if (file.path) {
				rkphplib.ajax({ url: this.options.url + '&remove_image=' + encodeURIComponent(file.name) });
			}
		});

		this.on("addedfile", function(file) {
			if (file.url) {
				this.options.rk.currFiles++;
			}
			else {
				this.options.rk.newFiles++;
			}

			if (this.options.maxFiles < this.options.rk.currFiles + this.options.rk.newFiles) {
				this.removeFile(file);
			}
		});

		// add existing files
		var existingFiles = {upload:exists}mode=dropzone{:upload};

		for (var i = 0; i < existingFiles.length; i++) {
			this.emit("addedfile", existingFiles[i]);
			this.emit("thumbnail", existingFiles[i], existingFiles[i].tbnUrl);
			this.emit("complete", existingFiles[i]);
		}
	}
}
</script>
