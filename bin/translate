#!/usr/bin/php
<?php

require_once(dirname(__DIR__).'/src/tok/Tokenizer.class.php');
require_once(dirname(__DIR__).'/src/File.class.php');
require_once(dirname(__DIR__).'/src/Dir.class.php');

use \rkphplib\tok\Tokenizer;
use \rkphplib\File;
use \rkphplib\Dir;


/**
 * Tokenizer to twig converter.
 *
 * @author Roland Kujundzic <roland@kujundzic.de>
 */
class TTwig implements TokPlugin {


/**
 * Return Tokenizer Plugin list:
 *
 * - autoescape, block, do, embed, extends, filter, flush, for, from, if, import, include, macro, sandbox, set, 
 *   spaceless, use, verbatim, v
 *
 * @param Tokenizer $tok
 * @return map<string:int>
 */
public function getPlugins($tok) {

	$plugin = [
		'autoescape' => TokPlugin::TOKCALL,
		'block' => TokPlugin::TOKCALL,
		'do' => TokPlugin::TOKCALL,
		'embed' => TokPlugin::TOKCALL,
		'extends' => TokPlugin::TOKCALL,
		'filter' => TokPlugin::TOKCALL,
		'flush' => TokPlugin::TOKCALL,
		'for' => TokPlugin::TOKCALL,
		'from' => TokPlugin::TOKCALL,
		'if' => TokPlugin::TOKCALL,
		'import' => TokPlugin::TOKCALL,
		'include' => TokPlugin::TOKCALL,
		'macro' => TokPlugin::TOKCALL,
		'sandbox' => TokPlugin::TOKCALL,
		'set' => TokPlugin::TOKCALL,
		'spaceless' => TokPlugin::TOKCALL,
		'use' => TokPlugin::TOKCALL,
		'verbatim' => TokPlugin::TOKCALL,
		'v' => TokPlugin::REQUIRE_PARAM | TokPlugin::NO_BODY
	];

	return $plugin;
}


/**
 * Convert {v:x} to {{ x }}.
 *
 * @param string $param
 * @return string
 */
public function tok_v($param) {
	return '{{ '.$param.' }}';
}


/**
 * Return {% $action $param %}$arg{% end$action %}.
 *
 * @param string $action
 * @param string $param
 * @param string $arg
 * @return string
 */
public function tokCall($action, $param, $arg) {
	$pa = mb_strlen($param) > 0 ? $param.' %}' : '%}';
	$res = '{% '.$action.' '.$pa.$arg.'{% end'.$action.' %}';
	return $res;
}

}

/*
 * M A I N
 */

$tok = new Tokenizer();
$txt_scanner = new TxtScanner();
$tok->register($txt_scanner);

if (empty($_SERVER['argv'][1])) {
	print "\nSYNTAX: ".$_SERVER['argv'][0]." [\$PWD|path_to_file]\n\n";
	exit(1);
}
else if (Dir::exists($_SERVER['argv'][1])) {
	$tok->load($_SERVER['argv'][1]);
	print $tok->toString();
}
else if (File::exists($_SERVER['argv'][1])) {
	$tok->load($_SERVER['argv'][1]);
	print $tok->toString();
}
else {
	print "\nSYNTAX: ".$_SERVER['argv'][0]." [\$PWD|path_to_file]\n\n";
	exit(1);
}


