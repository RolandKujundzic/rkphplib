#!/usr/bin/php
<?php

require_once('src/lib/config.php');
require_once('src/File.class.php');
require_once('src/Dir.class.php');

use \rkphplib\Exception;
use \rkphplib\File;
use \rkphplib\Dir;



/**
 * Add or remove comment "//" (mode = on|off) before "\rkphplib\lib\log_debug(", "rkphplib\lib\log_debug(",
 * "lib\log_debug(" and "log_debug(". Apply change if found at beginning of and not already on|off.
 * Use [// @keep] to disable processing.
 *  
 * @param string $file
 * @param bool $on
 */
function toggle_lib_debug($file, $on) {
	$lines = File::loadLines($file);
	$code_before = join('', $lines);
	$code = '';

	if ($on) {
		print "enable log_debug in $file\n";
	}
	else {
		print "disable log_debug in $file\n";
	}

	foreach ($lines as $line) {
		$new_line = '';

		if (!$on && preg_match('/^(\s*)\\\?rkphplib\\\lib\\\log_debug\(/', $line, $match)) {
			$ml = mb_strlen($match[1]);
			$new_line = $match[1].'// '.mb_substr($line, $ml);
		}
		else if ($on && preg_match('/^(\s*)\/\/ \\\?rkphplib\\\lib\\\log_debug\(/', $line, $match)) {
			$ml = mb_strlen($match[1]);
			$new_line = $match[1].mb_substr($line, $ml + 3); 
		}

		if ($new_line && strpos($line, '// @keep') === false) {
			if (substr(trim($line), -1) != ';') {
				throw new Exception('missing ";" at end of line: '."\n$line");
			}

			$line = $new_line;
		}

		$code .= $line;
	}

	if ($code_before != $code) {
		print "overwrite file with modified version\n";
		File::save($file, $code);
	}
	else {
		print "no change - keep file\n";
	}
}


/**
 * M A I N 
 */

if (empty($_SERVER['argv'][1]) || empty($_SERVER['argv'][2]) || !in_array($_SERVER['argv'][2], ['on', 'off'])) {
	print "\nSYNTAX: php ".$_SERVER['argv'][0]." PHP_FILE|PATH_TO_DIR on|off\n\n";
	exit(1);
}

$path = $_SERVER['argv'][1];
$on = $_SERVER['argv'][2] == 'on';

if (Dir::exists($path)) {
	$php_files = Dir::scanTree($path, [ 'php' ]);

	foreach ($php_files as $file) {
		toggle_lib_debug($file, $on);
	}
}
else if (File::exists($path)) {
	toggle_lib_debug($path, $on);
}
else {
	print "\nSYNTAX: php ".$_SERVER['argv'][0]." PHP_FILE|PATH_TO_DIR on|off\n\n";
	exit(1);
}
